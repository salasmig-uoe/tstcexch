<?xml version="1.0" encoding="UTF-8"?>
<sequence name="CardExchange_Inbound_Sequence" statistics="enable" trace="enable" xmlns="http://ws.apache.org/ns/synapse">
    <class name="uk.ac.ed.card.wso2.CardExchangeAuthenticator"/>
    <datamapper config="conf:card/cardexchange.dmc" description="Parse incoming CardExchange payload" inputSchema="conf:card/cardexchange_inputSchema.json" inputType="JSON" outputSchema="conf:card/cardexchange_outputSchema.json" outputType="JSON"/>
    <propertyGroup description="Integration endpoint resources">
        <property expression="get-property('env','IDM_WRITE_ENDPOINT')" name="uri.var.idmWriteEndpoint" scope="default" type="STRING"/>
        <property expression="get-property('env','CARD_API_ENDPOINT')" name="uri.var.cardApiEndpoint" scope="default" type="STRING"/>
    </propertyGroup>
    <clone continueParent="true" sequential="true">
        <target>
            <sequence>
                <sequence key="CardExchange_EnqueueCardAPI_Sequence"/>
            </sequence>
        </target>
    </clone>
    <filter regex="[0-9]+" source="json-eval($.edunicardserialnumber)">
        <then>
            <property description="Extracted PersonNumber" expression="json-eval($.person_id)" name="uri.var.personNumber" scope="default" type="STRING"/>
            <script language="js"><![CDATA[var message = mc.getPayloadJSON();
delete message.person_id;
delete message.photo;
mc.setPayloadJSON(message);]]></script>
            <sequence key="CardExchange_EnqueueIDMWrite_Sequence"/>
        </then>
        <else>
            <respond/>
        </else>
    </filter>
</sequence>
