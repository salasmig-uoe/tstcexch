<?xml version="1.0" encoding="UTF-8"?>
<sequence name="CardExchange_DefaultFault_Sequence" statistics="enable" trace="enable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom">
        <property name="LOG-PROCESSOR-DEFAULT-FAULT-SEQ" value="started"/>
    </log>
    <property expression="get-property('ERROR_CODE')" name="ERROR_CODE" scope="default" type="STRING"/>
    <property expression="get-property('ERROR_MESSAGE')" name="ERROR_MESSAGE" scope="default" type="STRING"/>
    <property expression="get-property('axis2','HTTP_SC')" name="ERROR_DETAIL" scope="default" type="STRING"/>
    <property name="ERROR_EXCEPTION" scope="default" type="STRING" value="call to cardapi endpoint failed"/>
    <log category="ERROR" level="custom">
        <property expression="$ctx:ERROR_MESSAGE" name="message"/>
        <property expression="$ctx:ERROR_CODE" name="code"/>
        <property expression="$ctx:ERROR_DETAIL" name="detail"/>
        <property expression="$ctx:ERROR_EXCEPTION" name="exception"/>
        <property expression="$ctx:RESPONSE_BODY" name="LOG-PROXY-ERROR-BODY"/>
        <property expression="$ctx:RESPONSE_BODY_BEFORE_CALL" name="LOG-PROXY-ERROR-BODY-BEFORE_CALL"/>
    </log>
    <log level="custom">
        <property expression="get-property('origPayload')" name="LOG-PROCESSOR-DEFAULT-FAULT-SEQUENCE"/>
        <property expression="$ctx:RESPONSE_BODY" name="LOG-PROXY-ERROR-BODY"/>
    </log>
    <payloadFactory media-type="json">
        <format>$1</format>
        <args>
            <arg evaluator="xml" expression="get-property('origPayload')"/>
        </args>
    </payloadFactory>
    <!-- don't save for now anything to the message store, just report the error 
    <store messageStore="card_cardexchange_cardapi_mq_error"/>
     -->
    <property description="Generate 202 response from mediation flow" name="FORCE_SC_ACCEPTED" scope="axis2" type="STRING" value="true"/>
    <property name="HTTP_SC" scope="axis2" type="STRING" value="202"/>
    <log level="custom">
        <property name="LOG-PROCESSOR-DEFAULT-FAULT-SEQUENCE" value=" message sent to error message store"/>
    </log>
    <!-- RESPOND WITH A 202 to indicate message was accepted and sent to an error queue for later processing -->
    <respond/>
</sequence>
